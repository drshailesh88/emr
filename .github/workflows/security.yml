name: Security Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  bandit-scan:
    name: Bandit Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit scan
        run: |
          bandit -r src/ \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium

      - name: Generate bandit HTML report
        if: always()
        run: |
          bandit -r src/ \
            -f html \
            -o bandit-report.html \
            --severity-level low \
            --confidence-level low

      - name: Upload bandit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-reports
          path: |
            bandit-report.json
            bandit-report.html
          retention-days: 90

      - name: Fail on high severity issues
        run: |
          bandit -r src/ \
            -ll \
            -f txt

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit

      - name: Install project dependencies
        run: pip install -r requirements.txt

      - name: Run safety check
        continue-on-error: true
        run: |
          safety check \
            --json \
            --output safety-report.json
          safety check --full-report

      - name: Run pip-audit
        continue-on-error: true
        run: |
          pip-audit \
            --format json \
            --output pip-audit-report.json
          pip-audit

      - name: Upload dependency reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports
          path: |
            safety-report.json
            pip-audit-report.json
          retention-days: 90

  semgrep-scan:
    name: Semgrep Code Analysis
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=auto \
            --json \
            --output=semgrep-report.json \
            src/

      - name: Run Semgrep with security rules
        continue-on-error: true
        run: |
          semgrep scan \
            --config "p/security-audit" \
            --config "p/secrets" \
            --config "p/owasp-top-ten" \
            --config "p/python" \
            --json \
            --output=semgrep-security-report.json \
            src/

      - name: Upload Semgrep reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-security-reports
          path: |
            semgrep-report.json
            semgrep-security-report.json
          retention-days: 90

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets
        run: |
          detect-secrets scan \
            --all-files \
            --exclude-files '\.git/.*' \
            --exclude-files '.*\.lock' \
            > .secrets.baseline

      - name: Audit secrets baseline
        run: |
          detect-secrets audit .secrets.baseline --report

      - name: Upload secrets report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-report
          path: .secrets.baseline
          retention-days: 90

  trufflehog-scan:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [bandit-scan, dependency-scan, semgrep-scan, secret-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate summary report
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "**Date:** $(date)" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "- Bandit: ${{ needs.bandit-scan.result }}" >> security-summary.md
          echo "- Dependencies: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- Semgrep: ${{ needs.semgrep-scan.result }}" >> security-summary.md
          echo "- Secrets: ${{ needs.secret-scan.result }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Artifacts" >> security-summary.md
          ls -lR security-artifacts/ >> security-summary.md

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

      - name: Comment PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  notify-on-failure:
    name: Notify on Security Issues
    runs-on: ubuntu-latest
    needs: [bandit-scan, dependency-scan, semgrep-scan, secret-scan]
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Send notification
        run: |
          echo "Security scan failed! Please check the artifacts."
          echo "Bandit: ${{ needs.bandit-scan.result }}"
          echo "Dependencies: ${{ needs.dependency-scan.result }}"
          echo "Semgrep: ${{ needs.semgrep-scan.result }}"
          echo "Secrets: ${{ needs.secret-scan.result }}"
          # Add Slack/email notification here if configured
