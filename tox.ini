[tox]
envlist = py311,py312,lint,type,security,coverage
skipsdist = True

[testenv]
description = Run tests with pytest
deps = -r requirements-dev.txt
commands = pytest tests/ -v --tb=short

[testenv:py311]
description = Run tests with Python 3.11
basepython = python3.11
commands = pytest tests/ -v

[testenv:py312]
description = Run tests with Python 3.12
basepython = python3.12
commands = pytest tests/ -v

[testenv:unit]
description = Run unit tests only
commands = pytest tests/unit/ tests/models/ tests/services/ -v -m "unit or not (integration or load or security)"

[testenv:integration]
description = Run integration tests
commands = pytest tests/integration/ -v -m integration

[testenv:smoke]
description = Run smoke tests
commands = pytest tests/smoke/ -v -m smoke --maxfail=1

[testenv:security]
description = Run security tests
commands = pytest tests/security/ -v -m security

[testenv:lint]
description = Run linting with flake8
deps =
    flake8>=6.0.0
    flake8-docstrings>=1.7.0
    flake8-bugbear>=23.0.0
commands =
    flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
    flake8 src/ --count --max-complexity=10 --max-line-length=127 --statistics

[testenv:type]
description = Run type checking with mypy
deps =
    mypy>=1.8.0
    types-requests>=2.31.0
commands =
    mypy src/ --ignore-missing-imports --check-untyped-defs

[testenv:security]
description = Run security checks with bandit
deps = bandit>=1.7.0
commands =
    bandit -r src/ -f txt --severity-level medium --skip B101

[testenv:coverage]
description = Run tests with coverage report
commands =
    pytest tests/ --cov=src --cov-report=html --cov-report=term-missing --cov-fail-under=70

[testenv:coverage-xml]
description = Run tests with XML coverage report (for CI)
commands =
    pytest tests/ --cov=src --cov-report=xml --cov-report=term

[testenv:quick]
description = Run quick tests only (skip slow tests)
commands = pytest tests/ -v -m "not slow" --maxfail=3

[testenv:failed]
description = Re-run only failed tests
commands = pytest tests/ --lf -v

[testenv:clean]
description = Clean up test artifacts
deps =
skip_install = true
commands =
    python -c "import shutil; import pathlib; [shutil.rmtree(p, ignore_errors=True) for p in ['.pytest_cache', 'htmlcov', '.coverage', '.tox', '__pycache__']]"

[flake8]
max-line-length = 127
extend-ignore = E203, E266, E501, W503
exclude =
    .git,
    __pycache__,
    .tox,
    .pytest_cache,
    htmlcov,
    *.egg-info,
    build,
    dist
max-complexity = 10

[coverage:run]
source = src
omit =
    */tests/*
    */conftest.py
    */__init__.py
    */ui/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False

[coverage:html]
directory = htmlcov

[coverage:xml]
output = coverage.xml
